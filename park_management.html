
<div style='text-align:center; margin:20px;'>
    <button style="padding:10px 20px; background:#3498db; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;" 
            onclick="window.top.showPage('home')">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–≥–æ–Ω–Ω—ã–º –ø–∞—Ä–∫–æ–º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }

        .container {
            width: 100%; max-width: 100%; padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1:before {
            content: "üöÜ";
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .park-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sector {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e1e5e9;
        }

        .sector h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .red-sector h2:before {
            content: "üè¢";
        }

        .linear-sector h2:before {
            content: "üõ§Ô∏è";
        }

        .upper-sector h2:before {
            content: "‚¨ÜÔ∏è";
        }

        .tracks-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .track {
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 10px;
            background: linear-gradient(to bottom, #f9f9f9, #eef2f5);
            min-height: 80px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .track-header {
            position: absolute;
            top: -12px;
            left: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 10;
        }

        .track-number {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .train-name {
            background: #2c3e50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .train-name:hover {
            background: #34495e;
        }

        .wagons-container {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
            min-height: 60px;
            padding: 5px;
            overflow-x: auto;
            position: relative;
        }

        .wagon {
            width: 60px;
            height: 30px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: move;
            user-select: none;
            border-radius: 4px;
            transition: transform 0.2s;
            flex-shrink: 0;
            position: relative;
            z-index: 5;
        }

        .wagon:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .wagon.single-deck {
            background: linear-gradient(135deg, #87CEEB, #63b8d4);
        }

        .wagon.double-deck {
            background: linear-gradient(135deg, #98FB98, #7cd47c);
            height: 40px;
        }

        .wagon-shadow {
            width: 60px;
            height: 30px;
            border: 2px dashed #3498db;
            background-color: rgba(52, 152, 219, 0.2);
            border-radius: 4px;
            flex-shrink: 0;
            transition: all 0.2s;
            position: absolute;
            z-index: 2;
        }

        .wagon-shadow.double-deck {
            height: 40px;
        }

        .empty-slot {
            width: 60px;
            height: 30px;
            border: 1px dashed #95a5a6;
            opacity: 0.6;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .drop-indicator {
            position: absolute;
            height: 100%;
            width: 3px;
            background-color: #e74c3c;
            z-index: 10;
            display: none;
            pointer-events: none;
        }

        .track-info {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #2c3e50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }

        .track-controls {
            position: absolute;
            bottom: 5px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .track-controls .btn {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu ul {
            list-style: none;
            padding: 5px 0;
        }

        .context-menu li {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .context-menu li:hover {
            background: #f0f2f5;
        }

        .context-menu li.edit:before {
            content: "‚úèÔ∏è ";
            margin-right: 5px;
        }

        .context-menu li.delete:before {
            content: "üóëÔ∏è ";
            margin-right: 5px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: flex; align-items: stretch; justify-content: center;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        H0%;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-train-modal h2:before {
            content: "‚ûï";
        }

        .edit-wagon-modal h2:before {
            content: "‚úèÔ∏è";
        }

        .edit-train-name-modal h2:before {
            content: "üè∑Ô∏è";
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group select, 
        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group select:focus, 
        .form-group textarea:focus,
        .form-group input:focus {
            border-color: #3498db;
            outline: none;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .dragging {
            opacity: 0.7;
            transform: rotate(5deg);
        }

        .drop-zone {
            border-color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }

        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Ä–∫–∞ */
        .right-sectors {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1100px) {
            .park-layout {
                grid-template-columns: 1fr;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .wagons-container::-webkit-scrollbar {
            height: 8px;
        }

        .wagons-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .wagons-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .wagons-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .drop-allowed {
            border-color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
        }
        
        .drop-not-allowed {
            border-color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }
        
        .insertion-point {
            width: 3px;
            height: 100%;
            background-color: #27ae60;
            position: absolute;
            z-index: 8;
            display: none;
        }
        
        .wagon-placeholder {
            width: 60px;
            height: 30px;
            border: 2px dashed #3498db;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .wagon-placeholder.double-deck {
            height: 40px;
        }
    
        
        
        /* === Compact Wagon Sizes (1/3 length) === */
        .wagon {
            width: 53px;
            display: inline-flex;
            align-items: flex-end;
            justify-content: center;
            cursor: grab;
            margin-right: 4px;
            position: relative;
        }
        .wagon img {
            width: 53px;
            display: block;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
        }
        .wagon.single-deck img {
            height: 30px;
        }
        .wagon.double-deck img {
            height: 47px;
        }

        .wagon-shadow {
            width: 53px;
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.85;
        }
        .wagon-shadow img {
            width: 53px;
            object-fit: contain;
        }

        .insertion-point {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: rgba(255,0,0,0.9);
            border-radius: 1px;
            z-index: 50;
        }



    
        /* === Wagon Number Above Image === */
        .wagon {
            flex-direction: column;
        }
        .wagon .wagon-number {
            font-size: 11px;
            font-weight: bold;
            color: #222;
            text-align: center;
            margin-bottom: 2px;
            line-height: 1;
            user-select: none;
            pointer-events: none;
        }
        .wagon img {
            display: block;
        }

</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–≥–æ–Ω–Ω—ã–º –ø–∞—Ä–∫–æ–º</h1>
            <div class="stats">
                <div class="stat-item">–ó–∞–Ω—è—Ç–æ: <span id="occupancy">0%</span></div>
                <div class="stat-item">–û–¥–Ω–æ—ç—Ç–∞–∂–Ω—ã–µ: <span id="single-deck-count">0</span></div>
                <div class="stat-item">–î–≤—É—Ö—ç—Ç–∞–∂–Ω—ã–µ: <span id="double-deck-count">0</span></div>
            </div>
            <button class="btn btn-primary" id="add-train-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–µ–∑–¥</button>
        </header>

        <div class="park-layout">
            <div class="sector red-sector">
                <h2>–†–≠–î</h2>
                <div class="tracks-container" id="red-tracks">
                    <!-- –ü—É—Ç–∏ 61-66 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            
            <div class="right-sectors">
                <div class="sector linear-sector">
                    <h2>–õ–∏–Ω–µ–π–Ω—ã–π –ø–∞—Ä–∫</h2>
                    <div class="tracks-container" id="linear-tracks">
                        <!-- –ü—É—Ç–∏ 40-47 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
                
                <div class="sector upper-sector">
                    <h2>–í–µ—Ä—Ö–Ω–∏–π –ø–∞—Ä–∫</h2>
                    <div class="tracks-container" id="upper-tracks">
                        <!-- –ü—É—Ç–∏ 23-26 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
    <div class="context-menu" id="context-menu">
        <ul>
            <li class="edit" id="context-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–≥–æ–Ω</li>
            <li class="delete" id="context-delete">–£–¥–∞–ª–∏—Ç—å –≤–∞–≥–æ–Ω</li>
        </ul>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∞ -->
    <div id="add-train-modal" class="modal add-train-modal">
        <div class="modal-content">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–µ–∑–¥</h2>
            <form id="add-train-form">
                <div class="form-group">
                    <label for="track-select">–í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å:</label>
                    <select id="track-select" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å --</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JavaScript -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="train-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞:</label>
                    <input type="text" id="train-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞">
                </div>
                
                <div class="form-group">
                    <label for="wagon-numbers">–ù–æ–º–µ—Ä–∞ –≤–∞–≥–æ–Ω–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
                    <textarea id="wagon-numbers" rows="4" placeholder="017-11111&#10;021-22222&#10;..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="train-type">–¢–∏–ø –ø–æ–µ–∑–¥–∞:</label>
                    <select id="train-type" required>
                        <option value="single">–û–¥–Ω–æ—ç—Ç–∞–∂–Ω—ã–π</option>
                        <option value="double">–î–≤—É—Ö—ç—Ç–∞–∂–Ω—ã–π</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn" id="cancel-add-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–≥–æ–Ω–∞ -->
    <div id="edit-wagon-modal" class="modal edit-wagon-modal">
        <div class="modal-content">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–≥–æ–Ω</h2>
            <form id="edit-wagon-form">
                <div class="form-group">
                    <label for="edit-wagon-number">–ù–æ–º–µ—Ä –≤–∞–≥–æ–Ω–∞:</label>
                    <input type="text" id="edit-wagon-number" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-wagon-type">–¢–∏–ø –≤–∞–≥–æ–Ω–∞:</label>
                    <select id="edit-wagon-type" required>
                        <option value="single">–û–¥–Ω–æ—ç—Ç–∞–∂–Ω—ã–π</option>
                        <option value="double">–î–≤—É—Ö—ç—Ç–∞–∂–Ω—ã–µ</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="delete-wagon-btn">–£–¥–∞–ª–∏—Ç—å</button>
                    <button type="button" class="btn" id="cancel-edit-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞ -->
    <div id="edit-train-name-modal" class="modal edit-train-name-modal">
        <div class="modal-content">
            <h2>–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞</h2>
            <form id="edit-train-name-form">
                <div class="form-group">
                    <label for="edit-train-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞:</label>
                    <input type="text" id="edit-train-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞">
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn" id="cancel-train-name-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∫–∞
        const parkStructure = {
            red: {
                name: "–†–≠–î",
                tracks: {
                    61: { capacity: 20, wagons: [], trainName: "" },
                    62: { capacity: 20, wagons: [], trainName: "" },
                    63: { capacity: 20, wagons: [], trainName: "" },
                    64: { capacity: 20, wagons: [], trainName: "" },
                    65: { capacity: 20, wagons: [], trainName: "" },
                    66: { capacity: 20, wagons: [], trainName: "" }
                }
            },
            linear: {
                name: "–õ–∏–Ω–µ–π–Ω—ã–π –ø–∞—Ä–∫",
                tracks: {
                    40: { capacity: 20, wagons: [], trainName: "" },
                    41: { capacity: 13, wagons: [], trainName: "" },
                    42: { capacity: 14, wagons: [], trainName: "" },
                    43: { capacity: 20, wagons: [], trainName: "" },
                    44: { capacity: 18, wagons: [], trainName: "" },
                    45: { capacity: 16, wagons: [], trainName: "" },
                    47: { capacity: 14, wagons: [], trainName: "" }
                }
            },
            upper: {
                name: "–í–µ—Ä—Ö–Ω–∏–π –ø–∞—Ä–∫",
                tracks: {
                    23: { capacity: 20, wagons: [], trainName: "" },
                    24: { capacity: 16, wagons: [], trainName: "" },
                    25: { capacity: 16, wagons: [], trainName: "" },
                    26: { capacity: 14, wagons: [], trainName: "" }
                }
            }
        };

        // –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π
        class ParkManagementSystem {
            constructor() {
                this.parkData = this.loadParkData();
                this.draggedWagon = null;
                this.editingWagon = null;
                this.contextMenuWagon = null;
                this.dragShadow = null;
                this.dropIndicator = null;
                this.currentDropIndex = null;
                this.currentDropSector = null;
                this.currentDropTrack = null;
                this.editingTrainName = null;
                this.initializeEventListeners();
                this.render();
                this.updateStatistics();
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            loadParkData() {
                const savedData = localStorage.getItem('parkData');
                if (savedData) {
                    return JSON.parse(savedData);
                } else {
                    return JSON.parse(JSON.stringify(parkStructure));
                }
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
            saveParkData() {
                localStorage.setItem('parkData', JSON.stringify(this.parkData));
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            initializeEventListeners() {
                // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∞
                document.getElementById('add-train-btn').addEventListener('click', () => {
                    this.showAddTrainModal();
                });

                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                document.getElementById('cancel-add-btn').addEventListener('click', () => {
                    this.hideAddTrainModal();
                });

                // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∞
                document.getElementById('add-train-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTrain();
                });

                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                    this.hideEditWagonModal();
                });

                // –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–≥–æ–Ω–∞
                document.getElementById('edit-wagon-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveWagonChanges();
                });

                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–≥–æ–Ω–∞
                document.getElementById('delete-wagon-btn').addEventListener('click', () => {
                    this.deleteWagon();
                });

                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
                document.getElementById('context-edit').addEventListener('click', () => {
                    if (this.contextMenuWagon) {
                        this.showEditWagonModal(
                            this.contextMenuWagon.id, 
                            this.contextMenuWagon.sector, 
                            this.contextMenuWagon.trackNumber
                        );
                        this.hideContextMenu();
                    }
                });

                document.getElementById('context-delete').addEventListener('click', () => {
                    if (this.contextMenuWagon) {
                        this.deleteWagonById(
                            this.contextMenuWagon.id, 
                            this.contextMenuWagon.sector, 
                            this.contextMenuWagon.trackNumber
                        );
                        this.hideContextMenu();
                    }
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu') && !e.target.closest('.wagon')) {
                        this.hideContextMenu();
                    }
                });

                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –Ω–∞ –≤–∞–≥–æ–Ω–∞—Ö
                document.addEventListener('contextmenu', (e) => {
                    if (e.target.closest('.wagon')) {
                        e.preventDefault();
                    }
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
                document.getElementById('add-train-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'add-train-modal') {
                        this.hideAddTrainModal();
                    }
                });

                document.getElementById('edit-wagon-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'edit-wagon-modal') {
                        this.hideEditWagonModal();
                    }
                });

                document.getElementById('edit-train-name-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'edit-train-name-modal') {
                        this.hideEditTrainNameModal();
                    }
                });

                // –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
                document.getElementById('edit-train-name-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveTrainNameChanges();
                });

                // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
                document.getElementById('cancel-train-name-btn').addEventListener('click', () => {
                    this.hideEditTrainNameModal();
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag and drop –ø–æ –≤—Å–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.updateDragShadow(e);
                });

                document.addEventListener('dragend', () => {
                    this.cleanupDrag();
                });
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–Ω–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
            createDragShadow(wagonType) {
                this.removeDragShadow();
                
                this.dragShadow = document.createElement('div');
                this.dragShadow.className = `wagon-shadow ${wagonType}-deck`;
                this.dragShadow.style.position = 'fixed';
                this.dragShadow.style.pointerEvents = 'none';
                this.dragShadow.style.zIndex = '1000';
                this.dragShadow.style.opacity = '0.8';
                
                document.body.appendChild(this.dragShadow);
                return this.dragShadow;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–Ω–∏
            updateDragShadow(e) {
                if (!this.dragShadow) return;
                
                this.dragShadow.style.left = `${e.pageX - 30}px`;
                this.dragShadow.style.top = `${e.pageY - 15}px`;
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–Ω–∏
            removeDragShadow() {
                if (this.dragShadow) {
                    this.dragShadow.remove();
                    this.dragShadow = null;
                }
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤—Å—Ç–∞–≤–∫–∏
            createDropIndicator() {
                this.removeDropIndicator();
                
                this.dropIndicator = document.createElement('div');
                this.dropIndicator.className = 'drop-indicator';
                this.dropIndicator.style.display = 'none';
                
                document.body.appendChild(this.dropIndicator);
                return this.dropIndicator;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–∫–∏
            showDropIndicator(x, y, height) {
                if (!this.dropIndicator) {
                    this.createDropIndicator();
                }
                
                this.dropIndicator.style.left = `${x}px`;
                this.dropIndicator.style.top = `${y}px`;
                this.dropIndicator.style.height = `${height}px`;
                this.dropIndicator.style.display = 'block';
            }

            // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–∫–∏
            hideDropIndicator() {
                if (this.dropIndicator) {
                    this.dropIndicator.style.display = 'none';
                }
            }

            // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–∫–∏
            removeDropIndicator() {
                if (this.dropIndicator) {
                    this.dropIndicator.remove();
                    this.dropIndicator = null;
                }
            }

            // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            cleanupDrag() {
                this.removeDragShadow();
                this.hideDropIndicator();
                this.currentDropIndex = null;
                this.currentDropSector = null;
                this.currentDropTrack = null;
                
                // –£–±—Ä–∞—Ç—å –≤—Å–µ –∫–ª–∞—Å—Å—ã drop-zone
                document.querySelectorAll('.track, .wagons-container').forEach(el => {
                    el.classList.remove('drop-zone', 'drop-allowed', 'drop-not-allowed');
                });
                
                // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—Å—Ç–∞–≤–∫–∏
                document.querySelectorAll('.insertion-point').forEach(el => {
                    el.remove();
                });
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            showContextMenu(e, wagonId, sector, trackNumber) {
                e.preventDefault();
                e.stopPropagation();
                
                this.contextMenuWagon = {
                    id: wagonId,
                    sector: sector,
                    trackNumber: trackNumber
                };
                
                const contextMenu = document.getElementById('context-menu');
                contextMenu.style.display = 'block';
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ä—è–¥–æ–º —Å –≤–∞–≥–æ–Ω–æ–º
                const wagonElement = e.target.closest('.wagon');
                if (wagonElement) {
                    const rect = wagonElement.getBoundingClientRect();
                    contextMenu.style.left = `${rect.right + window.scrollX}px`;
                    contextMenu.style.top = `${rect.top + window.scrollY}px`;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤–∞–≥–æ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                }
            }

            // –°–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            hideContextMenu() {
                document.getElementById('context-menu').style.display = 'none';
                this.contextMenuWagon = null;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∞
            showAddTrainModal() {
                const modal = document.getElementById('add-train-modal');
                const trackSelect = document.getElementById('track-select');
                
                // –û—á–∏—Å—Ç–∏—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π
                trackSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å --</option>';
                
                for (const [sectorName, sector] of Object.entries(this.parkData)) {
                    for (const [trackNumber, track] of Object.entries(sector.tracks)) {
                        const freeSlots = track.capacity - track.wagons.length;
                        if (freeSlots > 0) {
                            const option = document.createElement('option');
                            option.value = `${sectorName}-${trackNumber}`;
                            option.textContent = `${sector.name} - –ü—É—Ç—å ${trackNumber} (—Å–≤–æ–±–æ–¥–Ω–æ: ${freeSlots})`;
                            trackSelect.appendChild(option);
                        }
                    }
                }
                
                modal.style.display = 'flex';
            }

            // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∞
            hideAddTrainModal() {
                document.getElementById('add-train-modal').style.display = 'none';
                document.getElementById('add-train-form').reset();
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–≥–æ–Ω–∞
            showEditWagonModal(wagonId, sector, trackNumber) {
                const modal = document.getElementById('edit-wagon-modal');
                const track = this.parkData[sector].tracks[trackNumber];
                const wagon = track.wagons.find(w => w.id === wagonId);
                
                if (!wagon) return;
                
                this.editingWagon = { id: wagonId, sector, trackNumber };
                
                document.getElementById('edit-wagon-number').value = wagon.number;
                document.getElementById('edit-wagon-type').value = wagon.type;
                
                modal.style.display = 'flex';
            }

            // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–≥–æ–Ω–∞
            hideEditWagonModal() {
                document.getElementById('edit-wagon-modal').style.display = 'none';
                this.editingWagon = null;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
            showEditTrainNameModal(sector, trackNumber) {
                const modal = document.getElementById('edit-train-name-modal');
                const track = this.parkData[sector].tracks[trackNumber];
                
                this.editingTrainName = { sector, trackNumber };
                
                document.getElementById('edit-train-name').value = track.trainName || '';
                
                modal.style.display = 'flex';
            }

            // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
            hideEditTrainNameModal() {
                document.getElementById('edit-train-name-modal').style.display = 'none';
                this.editingTrainName = null;
            }

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
            saveTrainNameChanges() {
                if (!this.editingTrainName) return;
                
                const { sector, trackNumber } = this.editingTrainName;
                const track = this.parkData[sector].tracks[trackNumber];
                
                track.trainName = document.getElementById('edit-train-name').value.trim();
                
                this.saveParkData();
                this.render();
                this.hideEditTrainNameModal();
            }

            // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–µ–∑–¥
            addTrain() {
                const trackSelect = document.getElementById('track-select');
                const trainNameInput = document.getElementById('train-name');
                const wagonNumbersTextarea = document.getElementById('wagon-numbers');
                const trainTypeSelect = document.getElementById('train-type');
                
                const [sector, trackNumber] = trackSelect.value.split('-');
                const trainName = trainNameInput.value.trim();
                const wagonNumbers = wagonNumbersTextarea.value.split('\n')
                    .map(num => num.trim())
                    .filter(num => num !== '');
                const trainType = trainTypeSelect.value;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—É—Ç–∏
                if (!sector || !trackNumber) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å!');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–æ–≤ –≤–∞–≥–æ–Ω–æ–≤
                if (wagonNumbers.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –≤–∞–≥–æ–Ω–æ–≤!');
                    return;
                }
                
                const track = this.parkData[sector].tracks[trackNumber];
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—É—Ç–∏
                if (track.wagons.length + wagonNumbers.length > track.capacity) {
                    alert(`–ù–∞ –ø—É—Ç–∏ ${trackNumber} –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞! –î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—Ç: ${track.capacity - track.wagons.length}`);
                    return;
                }
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–µ–∑–¥–∞
                if (trainName) {
                    track.trainName = trainName;
                }
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–≥–æ–Ω–æ–≤
                wagonNumbers.forEach(number => {
                    const wagon = {
                        id: this.generateId(),
                        number: number,
                        type: trainType
                    };
                    track.wagons.push(wagon);
                });
                
                this.saveParkData();
                this.render();
                this.updateStatistics();
                this.hideAddTrainModal();
                
                alert(`–ü–æ–µ–∑–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø—É—Ç—å ${trackNumber}!`);
            }

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∞–≥–æ–Ω–∞
            saveWagonChanges() {
                if (!this.editingWagon) return;
                
                const { id, sector, trackNumber } = this.editingWagon;
                const track = this.parkData[sector].tracks[trackNumber];
                const wagon = track.wagons.find(w => w.id === id);
                
                if (!wagon) return;
                
                const newNumber = document.getElementById('edit-wagon-number').value.trim();
                const newType = document.getElementById('edit-wagon-type').value;
                
                if (!newNumber) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞–≥–æ–Ω–∞!');
                    return;
                }
                
                wagon.number = newNumber;
                wagon.type = newType;
                
                this.saveParkData();
                this.render();
                this.updateStatistics();
                this.hideEditWagonModal();
                
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            }

            // –£–¥–∞–ª–∏—Ç—å –≤–∞–≥–æ–Ω
            deleteWagon() {
                if (!this.editingWagon) return;
                
                const { id, sector, trackNumber } = this.editingWagon;
                const track = this.parkData[sector].tracks[trackNumber];
                const wagonIndex = track.wagons.findIndex(w => w.id === id);
                
                if (wagonIndex !== -1) {
                    track.wagons.splice(wagonIndex, 1);
                    this.saveParkData();
                    this.render();
                    this.updateStatistics();
                    this.hideEditWagonModal();
                    
                    alert('–í–∞–≥–æ–Ω —É–¥–∞–ª–µ–Ω!');
                }
            }

            // –û—á–∏—Å—Ç–∏—Ç—å –ø—É—Ç—å (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–µ–∑–¥)
            clearTrack(sector, trackNumber) {
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –ø—É—Ç—å ${trackNumber}?`)) {
                    this.parkData[sector].tracks[trackNumber].wagons = [];
                    this.parkData[sector].tracks[trackNumber].trainName = "";
                    this.saveParkData();
                    this.render();
                    this.updateStatistics();
                }
            }

            // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–∞–≥–æ–Ω–∞
            moveWagon(wagonId, fromSector, fromTrack, toSector, toTrack, insertIndex = null) {
                const fromTrackData = this.parkData[fromSector].tracks[fromTrack];
                const toTrackData = this.parkData[toSector].tracks[toTrack];
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ü–µ–ª–µ–≤–æ–≥–æ –ø—É—Ç–∏
                if (toTrackData.wagons.length >= toTrackData.capacity) {
                    alert(`–ù–∞ –ø—É—Ç–∏ ${toTrack} –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞!`);
                    return false;
                }
                
                // –ù–∞–π—Ç–∏ –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–∞–≥–æ–Ω
                const wagonIndex = fromTrackData.wagons.findIndex(w => w.id === wagonId);
                if (wagonIndex !== -1) {
                    const wagon = fromTrackData.wagons[wagonIndex];
                    fromTrackData.wagons.splice(wagonIndex, 1);
                    
                    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏, –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
                    if (insertIndex !== null && insertIndex >= 0 && insertIndex <= toTrackData.wagons.length) {
                        toTrackData.wagons.splice(insertIndex, 0, wagon);
                    } else {
                        // –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                        toTrackData.wagons.push(wagon);
                    }
                    
                    this.saveParkData();
                    this.render();
                    this.updateStatistics();
                    return true;
                }
                return false;
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞—Ä–∫–∞
            render() {
                this.renderSector('red', 'red-tracks');
                this.renderSector('linear', 'linear-tracks');
                this.renderSector('upper', 'upper-tracks');
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞
            renderSector(sectorName, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const sector = this.parkData[sectorName];
                
                for (const [trackNumber, track] of Object.entries(sector.tracks)) {
                    const trackElement = document.createElement('div');
                    trackElement.className = 'track';
                    trackElement.dataset.sector = sectorName;
                    trackElement.dataset.track = trackNumber;
                    
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É—Ç–∏ —Å –Ω–æ–º–µ—Ä–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–æ–µ–∑–¥–∞
                    const trackHeader = document.createElement('div');
                    trackHeader.className = 'track-header';
                    
                    // –ù–æ–º–µ—Ä –ø—É—Ç–∏
                    const trackNumberElement = document.createElement('div');
                    trackNumberElement.className = 'track-number';
                    trackNumberElement.textContent = `–ü—É—Ç—å ${trackNumber}`;
                    trackHeader.appendChild(trackNumberElement);
                    
                    // –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∞
                    const trainNameElement = document.createElement('div');
                    trainNameElement.className = 'train-name';
                    trainNameElement.textContent = track.trainName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    trainNameElement.title = track.trainName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                    trainNameElement.addEventListener('click', () => {
                        this.showEditTrainNameModal(sectorName, trackNumber);
                    });
                    trackHeader.appendChild(trainNameElement);
                    
                    trackElement.appendChild(trackHeader);
                    
                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏
                    const trackInfo = document.createElement('div');
                    trackInfo.className = 'track-info';
                    trackInfo.textContent = `${track.wagons.length}/${track.capacity}`;
                    trackElement.appendChild(trackInfo);
                    
                    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∞–≥–æ–Ω–æ–≤
                    const wagonsContainer = document.createElement('div');
                    wagonsContainer.className = 'wagons-container';
                    wagonsContainer.dataset.sector = sectorName;
                    wagonsContainer.dataset.track = trackNumber;
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤–∞–≥–æ–Ω–æ–≤
                    wagonsContainer.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        this.handleWagonsContainerDragOver(e, wagonsContainer, sectorName, trackNumber);
                    });
                    
                    wagonsContainer.addEventListener('dragleave', (e) => {
                        if (!wagonsContainer.contains(e.relatedTarget)) {
                            wagonsContainer.classList.remove('drop-zone', 'drop-allowed', 'drop-not-allowed');
                            this.hideInsertionPoints(wagonsContainer);
                        }
                    });
                    
                    wagonsContainer.addEventListener('drop', (e) => {
                        e.preventDefault();
                        this.handleWagonsContainerDrop(e, wagonsContainer, sectorName, trackNumber);
                    });
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞–≥–æ–Ω–æ–≤
                    track.wagons.forEach((wagon, index) => {
                        const wagonElement = this.createWagonElement(wagon, sectorName, trackNumber, index);
                        wagonsContainer.appendChild(wagonElement);
                    });
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Å—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤
                    const emptySlots = track.capacity - track.wagons.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'empty-slot';
                        wagonsContainer.appendChild(emptySlot);
                    }
                    
                    trackElement.appendChild(wagonsContainer);
                    
                    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É—Ç–µ–º
                    const trackControls = document.createElement('div');
                    trackControls.className = 'track-controls';
                    trackControls.innerHTML = `
                        <button class="btn btn-danger" data-sector="${sectorName}" data-track="${trackNumber}">–û—á–∏—Å—Ç–∏—Ç—å –ø—É—Ç—å</button>
                    `;
                    
                    trackControls.querySelector('button').addEventListener('click', () => {
                        this.clearTrack(sectorName, trackNumber);
                    });
                    
                    trackElement.appendChild(trackControls);
                    container.appendChild(trackElement);
                }
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–∞–≥–æ–Ω–∞
            createWagonElement(wagon, sectorName, trackNumber, index) {
                const wagonElement = document.createElement('div');
                wagonElement.className = `wagon ${wagon.type}-deck`;
                // Use image for wagon instead of plain square
                const img = document.createElement('img');
                img.alt = wagon.number || '';
                img.draggable = false;
                // Map types to provided images
                if (wagon.type === 'double') img.src = './wagon_double.jpeg'; else img.src = './wagon_single.jpeg';
                // Add number label above image
                const numLabel = document.createElement('div');
                numLabel.className = 'wagon-number';
                numLabel.textContent = wagon.number || '';
                wagonElement.appendChild(numLabel);
                wagonElement.appendChild(img);
                // show number as data attribute for accessibility
                wagonElement.setAttribute('title', wagon.number || '');
                wagonElement.draggable = true;
                wagonElement.dataset.wagonId = wagon.id;
                wagonElement.dataset.wagonIndex = index;
                wagonElement.dataset.wagonType = wagon.type;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag and drop
                wagonElement.addEventListener('dragstart', (e) => {
                    this.draggedWagon = {
                        id: wagon.id,
                        sector: sectorName,
                        track: trackNumber,
                        type: wagon.type,
                        index: index
                    };
                    e.dataTransfer.setData('text/plain', wagon.id);
                    wagonElement.classList.add('dragging');
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç–µ–Ω—å –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    this.createDragShadow(wagon.type);
                });
                
                wagonElement.addEventListener('dragend', () => {
                    wagonElement.classList.remove('dragging');
                    this.cleanupDrag();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                wagonElement.addEventListener('contextmenu', (e) => {
                    this.showContextMenu(e, wagon.id, sectorName, trackNumber);
                });
                
                return wagonElement;
            }

            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—Å—Ç–∞–≤–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            hideInsertionPoints(container) {
                const insertionPoints = container.querySelectorAll('.insertion-point');
                insertionPoints.forEach(point => point.remove());
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –Ω–∞–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –≤–∞–≥–æ–Ω–æ–≤
            
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –Ω–∞–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –≤–∞–≥–æ–Ω–æ–≤
            handleWagonsContainerDragOver(e, wagonsContainer, sectorName, trackNumber) {
                if (!this.draggedWagon) return;

                const rect = wagonsContainer.getBoundingClientRect();
                // Use container-relative coordinates (account for scroll)
                const x = e.clientX - rect.left + wagonsContainer.scrollLeft;

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–≤–∞–≥–æ–Ω—ã –∏ –ø—É—Å—Ç—ã–µ —Å–ª–æ—Ç—ã)
                const children = Array.from(wagonsContainer.children).filter(
                    child => !child.classList.contains('insertion-point')
                );

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—Å—Ç–∞–≤–∫–∏
                this.hideInsertionPoints(wagonsContainer);

                // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                let insertIndex = 0;
                let found = false;

                for (let i = 0; i < children.length; i++) {
                    const child = children[i];
                    // Use offsetLeft/offsetWidth which are relative to the container and include scroll
                    const childMiddle = child.offsetLeft + child.offsetWidth / 2;

                    if (x < childMiddle) {
                        insertIndex = i;
                        found = true;

                        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
                        const insertionPoint = document.createElement('div');
                        insertionPoint.className = 'insertion-point';
                        insertionPoint.style.left = `${child.offsetLeft - 3}px`;
                        insertionPoint.style.display = 'block';
                        wagonsContainer.insertBefore(insertionPoint, child);
                        break;
                    }
                }

                if (!found) {
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–∑–∏—Ü–∏—é, –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                    insertIndex = children.length;

                    // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Å—Ç–∞–≤–∫–∏ –≤ –∫–æ–Ω—Ü–µ
                    const insertionPoint = document.createElement('div');
                    insertionPoint.className = 'insertion-point';

                    if (children.length > 0) {
                        const lastChild = children[children.length - 1];
                        insertionPoint.style.left = `${lastChild.offsetLeft + lastChild.offsetWidth + 6}px`;
                    } else {
                        insertionPoint.style.left = `5px`;
                    }

                    insertionPoint.style.display = 'block';
                    wagonsContainer.appendChild(insertionPoint);
                }
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–∞–≥–æ–Ω —Å—é–¥–∞
                const targetTrack = this.parkData[sectorName].tracks[trackNumber];
                const canDrop = targetTrack.wagons.length < targetTrack.capacity;
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                wagonsContainer.classList.remove('drop-allowed', 'drop-not-allowed');
                if (canDrop) {
                    wagonsContainer.classList.add('drop-zone', 'drop-allowed');
                } else {
                    wagonsContainer.classList.add('drop-zone', 'drop-not-allowed');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å—Ç–∞–≤–∫–∏
                this.currentDropIndex = insertIndex;
                this.currentDropSector = sectorName;
                this.currentDropTrack = trackNumber;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –≤–∞–≥–æ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            handleWagonsContainerDrop(e, wagonsContainer, sectorName, trackNumber) {
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—Å—Ç–∞–≤–∫–∏
                this.hideInsertionPoints(wagonsContainer);
                
                if (!this.draggedWagon) return;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                const targetTrack = this.parkData[sectorName].tracks[trackNumber];
                if (targetTrack.wagons.length >= targetTrack.capacity) {
                    alert(`–ù–∞ –ø—É—Ç–∏ ${trackNumber} –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞!`);
                    this.cleanupDrag();
                    return;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å—Ç–∞–≤–∫–∏
                const insertIndex = this.currentDropIndex;
                
                if (insertIndex !== null) {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –≤ —Ç–æ—Ç –∂–µ –ø—É—Ç—å, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å
                    let adjustedIndex = insertIndex;
                    if (this.draggedWagon.sector === sectorName && 
                        this.draggedWagon.track === trackNumber) {
                        // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ —Ç–æ–º –∂–µ –ø—É—Ç–∏ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å –º–µ–Ω—å—à–µ —Ü–µ–ª–µ–≤–æ–≥–æ,
                        // –Ω—É–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ü–µ–ª–µ–≤–æ–π –∏–Ω–¥–µ–∫—Å –Ω–∞ 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏—Å—Ö–æ–¥–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω
                        if (this.draggedWagon.index < adjustedIndex) {
                            adjustedIndex--;
                        }
                    }
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    adjustedIndex = Math.min(adjustedIndex, targetTrack.wagons.length);
                    
                    const success = this.moveWagon(
                        this.draggedWagon.id,
                        this.draggedWagon.sector,
                        this.draggedWagon.track,
                        sectorName,
                        trackNumber,
                        adjustedIndex
                    );
                    
                    if (!success) {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–∞–≥–æ–Ω!');
                    }
                }
                
                this.cleanupDrag();
            }

            // –£–¥–∞–ª–∏—Ç—å –≤–∞–≥–æ–Ω –ø–æ ID
            deleteWagonById(wagonId, sector, trackNumber) {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∞–≥–æ–Ω?')) {
                    const track = this.parkData[sector].tracks[trackNumber];
                    const wagonIndex = track.wagons.findIndex(w => w.id === wagonId);
                    
                    if (wagonIndex !== -1) {
                        track.wagons.splice(wagonIndex, 1);
                        this.saveParkData();
                        this.render();
                        this.updateStatistics();
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            updateStatistics() {
                let totalCapacity = 0;
                let totalWagons = 0;
                let singleDeckCount = 0;
                let doubleDeckCount = 0;
                
                // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                for (const sector of Object.values(this.parkData)) {
                    for (const track of Object.values(sector.tracks)) {
                        totalCapacity += track.capacity;
                        totalWagons += track.wagons.length;
                        
                        track.wagons.forEach(wagon => {
                            if (wagon.type === 'single') {
                                singleDeckCount++;
                            } else {
                                doubleDeckCount++;
                            }
                        });
                    }
                }
                
                const occupancyPercentage = totalCapacity > 0 ? 
                    ((totalWagons / totalCapacity) * 100).toFixed(1) : 0;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('occupancy').textContent = `${occupancyPercentage}%`;
                document.getElementById('single-deck-count').textContent = singleDeckCount;
                document.getElementById('double-deck-count').textContent = doubleDeckCount;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            new ParkManagementSystem();
        });
    </script>
</body>
</html>